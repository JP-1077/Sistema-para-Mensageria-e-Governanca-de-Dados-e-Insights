WITH BASE_EXPORTACOES_DADOS_IR AS (

    SELECT
        DATA_OFERTA AS data_oferta_completa,
        DATE(DATA_OFERTA) AS data_oferta,
        TIME(DATA_OFERTA) AS data_oferta_hora,
        SITUACAO,
        NOME_INFRACO_ATUAL,
        MOTIVO,
        SUBMOTIVO,
        BASE_SCHEDULLE.SITE
    FROM `tim-sdbx-resjourney-3175.dm_prod.TB_CRC_ULTRATAB` AS BASE_CRC_ULTRATAB
    LEFT JOIN `tim-sdbx-live-a579.share_live_resjourney.VW_SHARE_BASE_ORDENS_DOC_END_CONTATO` AS BASE_ORDENS
        ON CAST(BASE_CRC_ULTRATAB.SERVICE_ID AS STRING) = BASE_ORDENS.COD_CONTRATO_ATUAL
    LEFT JOIN `tim-sdbx-resjourney-3175.dm_prod.VW_SCHEDULLE_SEMANAL_RN` AS BASE_SCHEDULLE 
        ON BASE_CRC_ULTRATAB.CONSULTOR_LOGIN = BASE_SCHEDULLE.LOGIN_REDE

),

calculos AS (

    SELECT

        -- Informações de Data e Horário atual  
        MAX(data_oferta) AS data_oferta_max,
        MAX(IF(DATE(data_oferta) = CURRENT_DATE(), data_oferta_hora, NULL)) AS data_oferta_hora_max,


        -- Informações de D-0
        COUNTIF(data_oferta = CURRENT_DATE()) AS PARCIAL_SOLICITACOES_D_0,
        COUNTIF(SITUACAO = 'Cancelado' AND data_oferta = CURRENT_DATE()) AS PARCIAL_CANCELADOS_D_0,
        COUNTIF(SITUACAO = 'Retido' AND data_oferta = CURRENT_DATE()) AS PARCIAL_RETIDOS_D_0,
        COUNTIF(NOME_INFRACO_ATUAL = 'VTAL' AND data_oferta = CURRENT_DATE()) AS PARCIAL_SOLICITACOES_VTAL_D_0,
        COUNTIF(SITUACAO = 'Retido' AND NOME_INFRACO_ATUAL = 'VTAL' AND data_oferta = CURRENT_DATE()) AS PARCIAL_RETIDOS_VTAL_D_0,
        COUNTIF(SITUACAO = 'Cancelado' AND NOME_INFRACO_ATUAL = 'VTAL' AND data_oferta = CURRENT_DATE()) AS PARCIAL_CANCELADOS_VTAL_D_0,
        COUNTIF(NOME_INFRACO_ATUAL <> 'VTAL' AND data_oferta = CURRENT_DATE()) AS PARCIAL_SOLICITACOES_IHS_D_0,
        COUNTIF(SITUACAO = 'Retido' AND NOME_INFRACO_ATUAL <> 'VTAL' AND data_oferta = CURRENT_DATE()) AS PARCIAL_RETIDOS_IHS_D_0,
        COUNTIF(SITUACAO = 'Cancelado' AND NOME_INFRACO_ATUAL <> 'VTAL' AND data_oferta = CURRENT_DATE()) AS PARCIAL_CANCELADOS_IHS_D_0,
        COUNTIF(SITE = 'TMKT' AND data_oferta = CURRENT_DATE()) AS PARCIAL_SOLICITACOES_TMKT_D_0,
        COUNTIF(SITUACAO = 'Retido' AND SITE = 'TMKT' AND data_oferta = CURRENT_DATE()) AS PARCIAL_RETIDOS_TMKT_D_0,
        COUNTIF(SITUACAO = 'Cancelado' AND SITE = 'TMKT' AND data_oferta = CURRENT_DATE()) AS PARCIAL_CANCELADOS_TMKT_D_0,
        COUNTIF(SITE = 'CONTAX' AND data_oferta = CURRENT_DATE()) AS PARCIAL_SOLICITACOES_CONTAX_D_0,
        COUNTIF(SITUACAO = 'Retido' AND SITE = 'CONTAX' AND data_oferta = CURRENT_DATE()) AS PARCIAL_RETIDOS_CONTAX_D_0,
        COUNTIF(SITUACAO = 'Cancelado' AND SITE = 'CONTAX' AND data_oferta = CURRENT_DATE()) AS PARCIAL_CANCELADOS_CONTAX_D_0,


        -- Informações em D-1
        COUNTIF(data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)) AS PARCIAL_SOLICITACOES_D_1,
        COUNTIF(SITUACAO = 'Cancelado' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)) AS PARCIAL_CANCELADOS_D_1,
        COUNTIF(SITUACAO = 'Retido' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)) AS PARCIAL_RETIDOS_D_1,
        COUNTIF(NOME_INFRACO_ATUAL = 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)) AS PARCIAL_SOLICITACOES_VTAL_D_1,
        COUNTIF(SITUACAO = 'Retido' AND NOME_INFRACO_ATUAL = 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)) AS PARCIAL_RETIDOS_VTAL_D_1,
        COUNTIF(SITUACAO = 'Cancelado' AND NOME_INFRACO_ATUAL = 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)) AS PARCIAL_CANCELADOS_VTAL_D_1,
        COUNTIF(NOME_INFRACO_ATUAL <> 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY)  AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)) AS PARCIAL_SOLICITACOES_IHS_D_1,
        COUNTIF(SITUACAO = 'Retido' AND NOME_INFRACO_ATUAL <> 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY) ) AS PARCIAL_RETIDOS_IHS_D_1,
        COUNTIF(SITUACAO = 'Cancelado' AND NOME_INFRACO_ATUAL <> 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)) AS PARCIAL_CANCELADOS_IHS_D_1,
        COUNTIF(SITE = 'TMKT' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)) AS PARCIAL_SOLICITACOES_TMKT_D_1,
        COUNTIF(SITUACAO = 'Retido' AND SITE = 'TMKT' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)) AS PARCIAL_RETIDOS_TMKT_D_1,
        COUNTIF(SITUACAO = 'Cancelado' AND SITE = 'TMKT' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)) AS PARCIAL_CANCELADOS_TMKT_D_1,
        COUNTIF(SITE = 'CONTAX' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)) AS PARCIAL_SOLICITACOES_CONTAX_D_1,
        COUNTIF(SITUACAO = 'Retido' AND SITE = 'CONTAX' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)) AS PARCIAL_RETIDOS_CONTAX_D_1,
        COUNTIF(SITUACAO = 'Cancelado' AND SITE = 'CONTAX' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 1 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 1 DAY)) AS PARCIAL_CANCELADOS_CONTAX_D_1,
        

        -- Informações em D-3
        COUNTIF(data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_SOLICITACOES_D_3,
        COUNTIF(SITUACAO = 'Cancelado' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_CANCELADOS_D_3,
        COUNTIF(SITUACAO = 'Retido' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_RETIDOS_D_3,
        COUNTIF(NOME_INFRACO_ATUAL = 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_SOLICITACOES_VTAL_D_3,       
        COUNTIF(SITUACAO = 'Retido' AND NOME_INFRACO_ATUAL = 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_RETIDOS_VTAL_D_3,
        COUNTIF(SITUACAO = 'Cancelado' AND NOME_INFRACO_ATUAL = 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_CANCELADOS_VTAL_D_3,
        COUNTIF(NOME_INFRACO_ATUAL <> 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY)  AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_SOLICITACOES_IHS_D_3,
        COUNTIF(SITUACAO = 'Retido' AND NOME_INFRACO_ATUAL <> 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_RETIDOS_IHS_D_3,
        COUNTIF(SITUACAO = 'Cancelado' AND NOME_INFRACO_ATUAL <> 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_CANCELADOS_IHS_D_3,
        COUNTIF(SITE = 'TMKT' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_SOLICITACOES_TMKT_D_3,
        COUNTIF(SITUACAO = 'Retido' AND SITE = 'TMKT' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_RETIDOS_TMKT_D_3,
        COUNTIF(SITUACAO = 'Cancelado' AND SITE = 'TMKT' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_CANCELADOS_TMKT_D_3,
        COUNTIF(SITE = 'CONTAX' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_SOLICITACOES_CONTAX_D_3,
        COUNTIF(SITUACAO = 'Retido' AND SITE = 'CONTAX' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_RETIDOS_CONTAX_D_3,
        COUNTIF(SITUACAO = 'Cancelado' AND SITE = 'CONTAX' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 3 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 3 DAY)) AS PARCIAL_CANCELADOS_CONTAX_D_3,


        -- Informações em D-7
        COUNTIF(data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_SOLICITACOES_D_7,
        COUNTIF(SITUACAO = 'Cancelado' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_CANCELADOS_D_7,
        COUNTIF(SITUACAO = 'Retido' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_RETIDOS_D_7,
        COUNTIF(NOME_INFRACO_ATUAL = 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_SOLICITACOES_VTAL_D_7,
        COUNTIF(SITUACAO = 'Retido' AND NOME_INFRACO_ATUAL = 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_RETIDOS_VTAL_D_7,
        COUNTIF(SITUACAO = 'Cancelado' AND NOME_INFRACO_ATUAL = 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_CANCELADOS_VTAL_D_7,
        COUNTIF(NOME_INFRACO_ATUAL <> 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY)  AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_SOLICITACOES_IHS_D_7,
        COUNTIF(SITUACAO = 'Retido' AND NOME_INFRACO_ATUAL <> 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_RETIDOS_IHS_D_7,
        COUNTIF(SITUACAO = 'Cancelado' AND NOME_INFRACO_ATUAL <> 'VTAL' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_CANCELADOS_IHS_D_7,
        COUNTIF(SITE = 'TMKT' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_SOLICITACOES_TMKT_D_7,
        COUNTIF(SITUACAO = 'Retido' AND SITE = 'TMKT' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_RETIDOS_TMKT_D_7,
        COUNTIF(SITUACAO = 'Cancelado' AND SITE = 'TMKT' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_CANCELADOS_TMKT_D_7,
        COUNTIF(SITE = 'CONTAX' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_SOLICITACOES_CONTAX_D_7,
        COUNTIF(SITUACAO = 'Retido' AND SITE = 'CONTAX' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_RETIDOS_CONTAX_D_7,
        COUNTIF(SITUACAO = 'Cancelado' AND SITE = 'CONTAX' AND data_oferta_completa >= TIMESTAMP_SUB(TIMESTAMP_TRUNC(CURRENT_TIMESTAMP(), DAY), INTERVAL 7 DAY) AND data_oferta_completa <  TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)) AS PARCIAL_CANCELADOS_CONTAX_D_7,



    FROM BASE_EXPORTACOES_DADOS_IR
    
)

SELECT 
    data_oferta_max, -- Data que o processo está sendo executado
    data_oferta_hora_max, -- Horário que o processo está sendo executado

    -- Volumetria de Solicitações, Cancelamentos e Retenção em D0 com aberturas (Infraco e SITE) e IR
    calculos.PARCIAL_SOLICITACOES_D_0, calculos.PARCIAL_CANCELADOS_D_0, calculos.PARCIAL_RETIDOS_D_0, 
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_D_0, calculos.PARCIAL_SOLICITACOES_D_0) * 100) AS TAXA_RETENCAO_GERAL_D_0,
    calculos.PARCIAL_SOLICITACOES_VTAL_D_0, calculos.PARCIAL_CANCELADOS_VTAL_D_0, calculos.PARCIAL_RETIDOS_VTAL_D_0,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_VTAL_D_0, calculos.PARCIAL_SOLICITACOES_VTAL_D_0) * 100) AS TAXA_RETENCAO_VTAL_D_0,
    calculos.PARCIAL_SOLICITACOES_IHS_D_0, calculos.PARCIAL_CANCELADOS_IHS_D_0, calculos.PARCIAL_RETIDOS_IHS_D_0,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_IHS_D_0, calculos.PARCIAL_SOLICITACOES_IHS_D_0) * 100) AS TAXA_RETENCAO_IHS_D_0,
    calculos.PARCIAL_SOLICITACOES_TMKT_D_0, calculos.PARCIAL_CANCELADOS_TMKT_D_0, calculos.PARCIAL_RETIDOS_TMKT_D_0,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_TMKT_D_0, calculos.PARCIAL_SOLICITACOES_TMKT_D_0) * 100) AS TAXA_RETENCAO_TMKT_D_0,
    calculos.PARCIAL_SOLICITACOES_CONTAX_D_0, calculos.PARCIAL_CANCELADOS_CONTAX_D_0, calculos.PARCIAL_RETIDOS_CONTAX_D_0,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_CONTAX_D_0, calculos.PARCIAL_SOLICITACOES_CONTAX_D_0) * 100) AS TAXA_RETENCAO_CONTAX_D_0,

    -- Volumetria de Solicitações, Cancelamentos e Retenção em D3 com aberturas (Infraco e SITE) e IR
    calculos.PARCIAL_SOLICITACOES_D_1,calculos.PARCIAL_CANCELADOS_D_1, calculos.PARCIAL_RETIDOS_D_1,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_D_1, calculos.PARCIAL_SOLICITACOES_D_1) * 100) AS TAXA_RETENCAO_GERAL_D_1,
    calculos.PARCIAL_SOLICITACOES_VTAL_D_1, calculos.PARCIAL_CANCELADOS_VTAL_D_1, calculos.PARCIAL_RETIDOS_VTAL_D_1,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_VTAL_D_1, calculos.PARCIAL_SOLICITACOES_VTAL_D_1) * 100) AS TAXA_RETENCAO_VTAL_D_1,
    calculos.PARCIAL_SOLICITACOES_IHS_D_1, calculos.PARCIAL_CANCELADOS_IHS_D_1, calculos.PARCIAL_RETIDOS_IHS_D_1,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_IHS_D_1, calculos.PARCIAL_SOLICITACOES_IHS_D_1) * 100) AS TAXA_RETENCAO_IHS_D_1,
    calculos.PARCIAL_SOLICITACOES_TMKT_D_1, calculos.PARCIAL_CANCELADOS_TMKT_D_1, calculos.PARCIAL_RETIDOS_TMKT_D_1,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_TMKT_D_1, calculos.PARCIAL_SOLICITACOES_TMKT_D_1) * 100) AS TAXA_RETENCAO_TMKT_D_1,
    calculos.PARCIAL_SOLICITACOES_CONTAX_D_1, calculos.PARCIAL_CANCELADOS_CONTAX_D_1, calculos.PARCIAL_RETIDOS_CONTAX_D_1,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_CONTAX_D_1, calculos.PARCIAL_SOLICITACOES_CONTAX_D_1) * 100) AS TAXA_RETENCAO_CONTAX_D_1,

    -- Volumetria de Solicitações, Cancelamentos e Retenção em D3 com aberturas (Infraco e SITE) e IR
    calculos.PARCIAL_SOLICITACOES_D_3,calculos.PARCIAL_CANCELADOS_D_3, calculos.PARCIAL_RETIDOS_D_3,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_D_3, calculos.PARCIAL_SOLICITACOES_D_3) * 100) AS TAXA_RETENCAO_GERAL_D_3,
    calculos.PARCIAL_SOLICITACOES_VTAL_D_3, calculos.PARCIAL_CANCELADOS_VTAL_D_3, calculos.PARCIAL_RETIDOS_VTAL_D_3,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_VTAL_D_3, calculos.PARCIAL_SOLICITACOES_VTAL_D_3) * 100) AS TAXA_RETENCAO_VTAL_D_3,
    calculos.PARCIAL_SOLICITACOES_IHS_D_3, calculos.PARCIAL_CANCELADOS_IHS_D_3, calculos.PARCIAL_RETIDOS_IHS_D_3,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_IHS_D_3, calculos.PARCIAL_SOLICITACOES_IHS_D_3) * 100) AS TAXA_RETENCAO_IHS_D_3,
    calculos.PARCIAL_SOLICITACOES_TMKT_D_3, calculos.PARCIAL_CANCELADOS_TMKT_D_3, calculos.PARCIAL_RETIDOS_TMKT_D_3,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_TMKT_D_3, calculos.PARCIAL_SOLICITACOES_TMKT_D_3) * 100) AS TAXA_RETENCAO_TMKT_D_3,
    calculos.PARCIAL_SOLICITACOES_CONTAX_D_3, calculos.PARCIAL_CANCELADOS_CONTAX_D_3, calculos.PARCIAL_RETIDOS_CONTAX_D_3,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_CONTAX_D_3, calculos.PARCIAL_SOLICITACOES_CONTAX_D_3) * 100) AS TAXA_RETENCAO_CONTAX_D_3,

    -- Volumetria de Solicitações, Cancelamentos e Retenção em D7 com aberturas (Infraco e SITE) e IR
    calculos.PARCIAL_SOLICITACOES_D_7, calculos.PARCIAL_CANCELADOS_D_7, calculos.PARCIAL_RETIDOS_D_7,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_D_7, calculos.PARCIAL_SOLICITACOES_D_7) * 100) AS TAXA_RETENCAO_GERAL_D_7,
    calculos.PARCIAL_SOLICITACOES_VTAL_D_7, calculos.PARCIAL_CANCELADOS_VTAL_D_7, calculos.PARCIAL_RETIDOS_VTAL_D_7,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_VTAL_D_7, calculos.PARCIAL_SOLICITACOES_VTAL_D_7) * 100) AS TAXA_RETENCAO_VTAL_D_7,
    calculos.PARCIAL_SOLICITACOES_IHS_D_7, calculos.PARCIAL_CANCELADOS_IHS_D_7, calculos.PARCIAL_RETIDOS_IHS_D_7,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_IHS_D_7, calculos.PARCIAL_SOLICITACOES_IHS_D_7) * 100) AS TAXA_RETENCAO_IHS_D_7,
    calculos.PARCIAL_SOLICITACOES_TMKT_D_7, calculos.PARCIAL_CANCELADOS_TMKT_D_7, calculos.PARCIAL_RETIDOS_TMKT_D_7,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_TMKT_D_7, calculos.PARCIAL_SOLICITACOES_TMKT_D_7) * 100) AS TAXA_RETENCAO_TMKT_D_7,
    calculos.PARCIAL_SOLICITACOES_CONTAX_D_7, calculos.PARCIAL_CANCELADOS_CONTAX_D_7, calculos.PARCIAL_RETIDOS_CONTAX_D_7,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_CONTAX_D_7, calculos.PARCIAL_SOLICITACOES_CONTAX_D_7) * 100) AS TAXA_RETENCAO_CONTAX_D_7,

    -- Variações de Solicitações, Cancelamentos e Retenção em D0 e D1 com aberturas (Infraco e SITE)
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_SOLICITACOES_D_0 - PARCIAL_SOLICITACOES_D_1, PARCIAL_SOLICITACOES_D_1) * 100) AS VAR_GERAL_SOLICITACOES_D0_D1,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_CANCELADOS_D_0 - PARCIAL_CANCELADOS_D_1, PARCIAL_CANCELADOS_D_1) * 100) AS VAR_GERAL_CANCELADOS_D0_D1,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_RETIDOS_D_0 - PARCIAL_RETIDOS_D_1, PARCIAL_RETIDOS_D_1) * 100) AS VAR_GERAL_RETIDOS_D0_D1,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_SOLICITACOES_VTAL_D_0 - PARCIAL_SOLICITACOES_VTAL_D_1, PARCIAL_SOLICITACOES_VTAL_D_1) * 100) VAR_VTAL_SOLICITACOES_D0_D1, 
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_CANCELADOS_VTAL_D_0 - PARCIAL_CANCELADOS_VTAL_D_1, PARCIAL_CANCELADOS_VTAL_D_1) * 100) VAR_VTAL_CANCELADOS_D0_D1,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_VTAL_D_0 - PARCIAL_RETIDOS_VTAL_D_1, PARCIAL_RETIDOS_VTAL_D_1) * 100) VAR_VTAL_RETIDOS_D0_D1,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_SOLICITACOES_IHS_D_0 - PARCIAL_SOLICITACOES_IHS_D_1, PARCIAL_SOLICITACOES_IHS_D_1) * 100) VAR_IHS_SOLICITACOES_D0_D1, 
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_CANCELADOS_IHS_D_0 - PARCIAL_CANCELADOS_IHS_D_1, PARCIAL_CANCELADOS_IHS_D_1) * 100) VAR_IHS_CANCELADOS_D0_D1,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_IHS_D_0 - PARCIAL_RETIDOS_IHS_D_1, PARCIAL_RETIDOS_IHS_D_1) * 100) VAR_IHS_RETIDOS_D0_D1,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_SOLICITACOES_TMKT_D_0 - PARCIAL_SOLICITACOES_TMKT_D_1, PARCIAL_SOLICITACOES_TMKT_D_1) * 100) VAR_TMKT_SOLICITACOES_D0_D1, 
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_CANCELADOS_TMKT_D_0 - PARCIAL_CANCELADOS_TMKT_D_1, PARCIAL_CANCELADOS_TMKT_D_1) * 100) VAR_TMKT_CANCELADOS_D0_D1,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_TMKT_D_0 - PARCIAL_RETIDOS_TMKT_D_1, PARCIAL_RETIDOS_TMKT_D_1) * 100) VAR_TMKT_RETIDOS_D0_D1,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_SOLICITACOES_CONTAX_D_0 - PARCIAL_SOLICITACOES_CONTAX_D_1, PARCIAL_SOLICITACOES_CONTAX_D_1) * 100) VAR_CONTAX_SOLICITACOES_D0_D1, 
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_CANCELADOS_CONTAX_D_0 - PARCIAL_CANCELADOS_CONTAX_D_1, PARCIAL_CANCELADOS_CONTAX_D_1) * 100) VAR_CONTAX_CANCELADOS_D0_D1,
    FORMAT('%.1f%%', SAFE_DIVIDE(calculos.PARCIAL_RETIDOS_CONTAX_D_0 - PARCIAL_RETIDOS_CONTAX_D_1, PARCIAL_RETIDOS_CONTAX_D_1) * 100) VAR_CONTAX_RETIDOS_D0_D1,
    
    -- Variações de Solicitações, Cancelamentos e Retenção em D0 e D3 com aberturas (Infraco e SITE)
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_SOLICITACOES_D_0 - PARCIAL_SOLICITACOES_D_3, PARCIAL_SOLICITACOES_D_3) * 100) AS VAR_GERAL_SOLICITACOES_D0_D3,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_CANCELADOS_D_0 - PARCIAL_CANCELADOS_D_3, PARCIAL_CANCELADOS_D_3) * 100) AS VAR_GERAL_CANCELADOS_D0_D3,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_RETIDOS_D_0 - PARCIAL_RETIDOS_D_3, PARCIAL_RETIDOS_D_3) * 100) AS VAR_GERAL_RETIDOS_D0_D3,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_SOLICITACOES_VTAL_D_0 - PARCIAL_SOLICITACOES_VTAL_D_3, PARCIAL_SOLICITACOES_VTAL_D_3) * 100) AS VAR_VTAL_SOLICITACOES_D0_D3,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_CANCELADOS_VTAL_D_0 - PARCIAL_CANCELADOS_VTAL_D_3, PARCIAL_CANCELADOS_VTAL_D_3) * 100) AS VAR_VTAL_CANCELADOS_D0_D3,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_RETIDOS_VTAL_D_0 - PARCIAL_RETIDOS_VTAL_D_3, PARCIAL_RETIDOS_VTAL_D_3) * 100) AS VAR_VTAL_RETIDOS_D0_D3,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_SOLICITACOES_IHS_D_0 - PARCIAL_SOLICITACOES_IHS_D_3, PARCIAL_SOLICITACOES_IHS_D_3) * 100) AS VAR_IHS_SOLICITACOES_D0_D3,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_CANCELADOS_IHS_D_0 - PARCIAL_CANCELADOS_IHS_D_3, PARCIAL_CANCELADOS_IHS_D_3) * 100) AS VAR_IHS_CANCELADOS_D0_D3,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_RETIDOS_IHS_D_0 - PARCIAL_RETIDOS_IHS_D_3, PARCIAL_RETIDOS_IHS_D_3) * 100) AS VAR_IHS_RETIDOS_D0_D3,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_SOLICITACOES_TMKT_D_0 - PARCIAL_SOLICITACOES_TMKT_D_3, PARCIAL_SOLICITACOES_TMKT_D_3) * 100) AS VAR_TMKT_SOLICITACOES_D0_D3,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_CANCELADOS_TMKT_D_0 - PARCIAL_CANCELADOS_TMKT_D_3, PARCIAL_CANCELADOS_TMKT_D_3) * 100) AS VAR_TMKT_CANCELADOS_D0_D3,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_RETIDOS_TMKT_D_0 - PARCIAL_RETIDOS_TMKT_D_3, PARCIAL_RETIDOS_TMKT_D_3) * 100) AS VAR_TMKT_RETIDOS_D0_D3,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_SOLICITACOES_CONTAX_D_0 - PARCIAL_SOLICITACOES_CONTAX_D_3, PARCIAL_SOLICITACOES_CONTAX_D_3) * 100) AS VAR_CONTAX_SOLICITACOES_D0_D3,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_CANCELADOS_CONTAX_D_0 - PARCIAL_CANCELADOS_CONTAX_D_3, PARCIAL_CANCELADOS_CONTAX_D_3) * 100) AS VAR_CONTAX_CANCELADOS_D0_D3,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_RETIDOS_CONTAX_D_0 - PARCIAL_RETIDOS_CONTAX_D_3, PARCIAL_RETIDOS_CONTAX_D_3) * 100) AS VAR_CONTAX_RETIDOS_D0_D3,

    -- Variações de Solicitações, Cancelamentos e Retenção em D0 e D7 com aberturas (Infraco e SITE)
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_SOLICITACOES_D_0 - PARCIAL_SOLICITACOES_D_7, PARCIAL_SOLICITACOES_D_7) * 100) AS VAR_GERAL_SOLICITACOES_D0_D7,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_CANCELADOS_D_0 - PARCIAL_CANCELADOS_D_7, PARCIAL_CANCELADOS_D_7) * 100) AS VAR_GERAL_CANCELADOS_D0_D7,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_RETIDOS_D_0 - PARCIAL_RETIDOS_D_7, PARCIAL_RETIDOS_D_7) * 100) AS VAR_GERAL_RETIDOS_D0_D7,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_SOLICITACOES_VTAL_D_0 - PARCIAL_SOLICITACOES_VTAL_D_7, PARCIAL_SOLICITACOES_VTAL_D_7) * 100) AS VAR_VTAL_SOLICITACOES_D0_D7,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_CANCELADOS_VTAL_D_0 - PARCIAL_CANCELADOS_VTAL_D_7, PARCIAL_CANCELADOS_VTAL_D_7) * 100) AS VAR_VTAL_CANCELADOS_D0_D7,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_RETIDOS_VTAL_D_0 - PARCIAL_RETIDOS_VTAL_D_7, PARCIAL_RETIDOS_VTAL_D_7) * 100) AS VAR_VTAL_RETIDOS_D0_D7,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_SOLICITACOES_IHS_D_0 - PARCIAL_SOLICITACOES_IHS_D_7, PARCIAL_SOLICITACOES_IHS_D_7) * 100) AS VAR_IHS_SOLICITACOES_D0_D7,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_CANCELADOS_IHS_D_0 - PARCIAL_CANCELADOS_IHS_D_7, PARCIAL_CANCELADOS_IHS_D_7) * 100) AS VAR_IHS_CANCELADOS_D0_D7,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_RETIDOS_IHS_D_0 - PARCIAL_RETIDOS_IHS_D_7, PARCIAL_RETIDOS_IHS_D_7) * 100) AS VAR_IHS_RETIDOS_D0_D7,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_SOLICITACOES_TMKT_D_0 - PARCIAL_SOLICITACOES_TMKT_D_7, PARCIAL_SOLICITACOES_TMKT_D_7) * 100) AS VAR_TMKT_SOLICITACOES_D0_D7,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_CANCELADOS_TMKT_D_0 - PARCIAL_CANCELADOS_TMKT_D_7, PARCIAL_CANCELADOS_TMKT_D_7) * 100) AS VAR_TMKT_CANCELADOS_D0_D7,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_RETIDOS_TMKT_D_0 - PARCIAL_RETIDOS_TMKT_D_7, PARCIAL_RETIDOS_TMKT_D_7) * 100) AS VAR_TMKT_RETIDOS_D0_D7,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_SOLICITACOES_CONTAX_D_0 - PARCIAL_SOLICITACOES_CONTAX_D_7, PARCIAL_SOLICITACOES_CONTAX_D_7) * 100) AS VAR_CONTAX_SOLICITACOES_D0_D7,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_CANCELADOS_CONTAX_D_0 - PARCIAL_CANCELADOS_CONTAX_D_7, PARCIAL_CANCELADOS_CONTAX_D_7) * 100) AS VAR_CONTAX_CANCELADOS_D0_D7,
    FORMAT('%.1f%%', SAFE_DIVIDE(PARCIAL_RETIDOS_CONTAX_D_0 - PARCIAL_RETIDOS_CONTAX_D_7, PARCIAL_RETIDOS_CONTAX_D_7) * 100) AS VAR_CONTAX_RETIDOS_D0_D7,
    
FROM calculos